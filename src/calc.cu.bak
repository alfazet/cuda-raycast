#include "calc.cuh"

inline __device__ __host__ float triangleIntersection(float3 origin, float3 dir, Triangle* triangle, float3* normal)
{
    float3 e1 = triangle->b - triangle->a;
    float3 e2 = triangle->c - triangle->a;
    *normal = cross(e1, e2);
    float3 dir_e2_cross = cross(dir, e2);
    float det = dot(e1, dir_e2_cross);
    if (abs(det) < EPS)
    {
        return 0;
    }
    float inv_det = 1.0f / det;
    float3 s = origin - triangle->a;
    float u = inv_det * dot(s, dir_e2_cross);
    if ((u < 0 && abs(u) > EPS) || (u > 1 && abs(u - 1) > EPS))
    {
        return 0;
    }
    float3 s_e1_cross = cross(s, e1);
    float v = inv_det * dot(dir, s_e1_cross);
    if ((v < 0 && abs(v) > EPS) || (u + v > 1 && abs(u + v - 1) > EPS))
    {
        return 0;
    }
    float t = inv_det * dot(e2, s_e1_cross);

    return t > EPS ? t : 0.0f;
}

inline __device__ __host__ uchar3 rgbFloatsToBytes(float3 color)
{
    unsigned char r = static_cast<unsigned char>(255.0 * color.x);
    unsigned char g = static_cast<unsigned char>(255.0 * color.y);
    unsigned char b = static_cast<unsigned char>(255.0 * color.z);

    return make_uchar3(r, g, b);
}